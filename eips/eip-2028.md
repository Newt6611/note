Original GitHub Link: https://github.com/ethereum/EIPs/blob/master/EIPS/eip-2028.md

# EIP-2028 學習筆記

## 摘要 (Summary)
EIP-2028 降低了交易中數據（Calldata）的 Gas 消耗。具體來說，它將非零字節的 Gas 成本從 68 降低到 16。

## 動機 (Motivation)
這個提案的主要動機有兩個：
1.  **提高擴展性 (Scalability):** 降低 Calldata 成本可以增加區塊中能夠容納的數據量，從而提高網路的吞吐量。這對 Layer 2 解決方案（如 Rollups）特別有利，因為它們依賴於將數據發佈到 Layer 1。
2.  **減少延遲 (Delay):** 較低的數據成本有助於減少寫入數據的延遲。

## 規範細節 (Specification Details)
- 將 `G_txdatanonzero` (非零字節的 Gas 成本) 從 68 Gas 降低到 16 Gas。
- 零字節的 Gas 成本 (`G_txdatazero`) 保持不變，為 4 Gas。

## Go-Ethereum 實作程式碼 (Implementation)
核心實作位於 `core/state_transition.go` 中的 `IntrinsicGas` 函數，以及 `params/protocol_params.go` 中的參數定義。

### 參數定義
在 `params/protocol_params.go` 中：

```go
// params/protocol_params.go

const (
    TxDataZeroGas           uint64 = 4  // Per byte of data attached to a transaction that equals zero.
    TxDataNonZeroGasEIP2028 uint64 = 16 // Per byte of non zero data attached to a transaction after EIP 2028
)
```

### Gas 計算邏輯
在 `core/state_transition.go` 中，`IntrinsicGas` 函數根據 EIP-2028 是否啟用來選擇不同的非零字節成本：

```go
// core/state_transition.go

func IntrinsicGas(data []byte, ... isEIP2028 bool ...) (uint64, error) {
    // ...
    dataLen := uint64(len(data))
    if dataLen > 0 {
        z := uint64(bytes.Count(data, []byte{0}))
        nz := dataLen - z
        
        nonZeroGas := params.TxDataNonZeroGasFrontier // 預設為舊值 (68)
        if isEIP2028 {
            nonZeroGas = params.TxDataNonZeroGasEIP2028 // EIP-2028 啟用後為 16
        }
        
        gas += nz * nonZeroGas
        gas += z * params.TxDataZeroGas
        // ...
    }
    // ...
    return gas, nil
}
```

## 深入解析：Intrinsic Gas (固有 Gas)

`IntrinsicGas` 是交易的**「入場費」**或**「基本底薪」**。在 EVM 真正執行合約邏輯（運算、修改狀態）**之前**，節點會先計算並預扣這筆費用。

### 1. 收銀員角色
想像 `IntrinsicGas` 是店門口的收銀員：
- **預扣款：** 確保發送者帳戶至少有足夠的 Gas 支付基本開銷。
- **門檻檢查：** 如果交易設定的 `GasLimit` 低於 `IntrinsicGas`，交易連合約的門都進不去，直接報錯：`intrinsic gas too low`。

### 2. 計算公式
基本組成如下：
$Total\_Intrinsic\_Gas = 21,000 + (NonZeroBytes \times 16) + (ZeroBytes \times 4) + (\text{其他額外費用})$

*   **21,000:** 每一筆 Ethereum 交易的固定基礎費用。
*   **Calldata 部分:** 根據 EIP-2028 調整後的參數計算。

### 3. 實戰範例
假設發送一筆交易，其 `Data` (Calldata) 為 `0x123400`：
- **數據組成:** 2 個非零字節 (`12`, `34`)，1 個零字節 (`00`)。
- **計算過程:**
    - 基礎費：$21,000$
    - 非零字節：$2 \times 16 = 32$
    - 零字節：$1 \times 4 = 4$
- **總 Intrinsic Gas:** $21,000 + 32 + 4 = 21,036$ Gas。

---

## 常見問題 (Q&A)

### 1. 為什麼非零字節的成本 (16 Gas) 仍然是零字節 (4 Gas) 的 4 倍？
這主要反映了真實的物理資源消耗差異：
- **存儲與頻寬:** 非零字節代表實際的資訊，無法像零字節那樣被輕易壓縮。在數據傳播（P2P 廣播）和寫入硬碟時，非零字節佔用的資源確實更多。
- **防止攻擊:** 如果非零字節太便宜，攻擊者可以用垃圾數據填滿區塊，導致區塊體積過大，增加網路延遲 (Network Latency)，進而影響網路的去中心化程度（因為頻寬較小的節點會跟不上）。

### 2. 降低 Calldata 成本是否會導致區塊大小顯著增加？
是的，這是一個主要的副作用。
- **EIP-2028 的影響:** 降低 Gas 成本後，理論上的最大區塊大小增加了約 4 倍（從約 0.5MB 增加到約 2MB，假設整個區塊都塞滿 Calldata）。
- **EIP-4488 的後續討論:** 當社群討論進一步降低成本（例如降到 3 Gas）以支援 Rollups 時，發現這會讓最大區塊大小暴增到 10MB 以上，這是網路無法承受的。
- **解決方案:** 因此，後來的提案如 **EIP-4488** 建議在降低 Gas 的同時，必須引入一個**「區塊 Calldata 總量上限 (Calldata Limit)」**。而最終，Ethereum 選擇了 **[[eip-4844]] (Blob)** 路線，通過引入完全獨立的數據空間來解決這個問題，而不是繼續在傳統的 Calldata 上做文章。
