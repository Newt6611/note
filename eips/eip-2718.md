Original GitHub Link: https://github.com/ethereum/EIPs/blob/master/EIPS/eip-2718.md

# EIP-2718 學習筆記

## 摘要 (Summary)
EIP-2718 定義了一種新的交易包裹格式（Typed Transaction Envelope）。它引入了一個 `TransactionType` 前綴，使得以太坊能夠支持多種不同類型的交易格式，而不會發生解析衝突。格式為：`TransactionType || TransactionPayload`。

## 動機 (Motivation)
在 EIP-2718 之前，所有新交易類型都必須與舊交易 RLP 編碼兼容，這導致添加新功能（如 [[eip-155]]）時非常困難且容易產生衝突。透過定義一個標準的「信封」格式，未來的 EIP 只需要申請一個唯一的 `TransactionType` 編號，而不需要擔心與現有交易格式的解碼衝突。

## 規範細節 (Specification Details)
- **格式**：`TransactionType || TransactionPayload`。
- **TransactionType**：一個 8-bit 的整數，範圍從 `0x00` 到 `0x7f`（0-127）。
- **區分遺留交易**：
  - 遺留交易 (Legacy Transactions) 的第一個字節始終 `>= 0xc0` (RLP List 的開頭)。
  - 透過限制 Typed Transaction 的第一個字節在 `0x00` 到 `0x7f` 之間，客戶端可以輕鬆區分這兩者。
- **簽名安全**：強烈建議將 `TransactionType` 作為被簽名數據的第一個字節，以防止跨類型的簽名重放。

## Go-Ethereum 實作程式碼 (Implementation)
在 Geth 中，交易結構和解析邏輯進行了重大重構以支持 Typed Transactions。

相關程式碼主要位於 `core/types/transaction.go` 以及各個交易類型的獨立文件中（如 `legacy_tx.go`, `dynamic_fee_tx.go`, `access_list_tx.go`）。**注意：並沒有一個單獨的 `typed_tx.go` 文件。**

```go
// core/types/transaction.go

// Transaction is an Ethereum transaction.
type Transaction struct {
    inner TxData    // TxData 是個介面，可以是 LegacyTx, AccessListTx, DynamicFeeTx 等
    time  time.Time
}

// TxData 是所有交易類型的介面，定義在 transaction.go 中
type TxData interface {
    txType() byte
    copy() TxData
    chainID() *big.Int
    accessList() AccessList
    data() []byte
    gas() uint64
    gasPrice() *big.Int
    gasTipCap() *big.Int
    gasFeeCap() *big.Int
    value() *big.Int
    nonce() uint64
    to() *common.Address

    rawSignatureValues() (v, r, s *big.Int)
    setSignatureValues(chainID, v, r, s *big.Int)
}
```

具體的交易類型實作通常分佈在：
- `core/types/legacy_tx.go`: `LegacyTx` (Type 0x00, 但其實是 default)
- `core/types/access_list_tx.go`: `AccessListTx` (EIP-2930, Type 0x01)
- `core/types/dynamic_fee_tx.go`: `DynamicFeeTx` (EIP-1559, Type 0x02)

## 思考與疑問 (Thoughts & Questions)
- **為什麼範圍只到 0x7f？** 這是為了確保不與 RLP 編碼衝突。RLP 編碼的長度大於 55 字節的列表開頭是 0xf7 往上，單字節 0x00-0x7f 代表自身，所以 0x7f 以下是安全的。
- **對 Receipt 的影響**：Receipt 同樣也支持了 Typed 格式，這對於輕客戶端驗證非常重要。
- **後續影響**：EIP-2930 (Access Lists) 和 EIP-1559 (Dynamic Fee) 都是基於 EIP-2718 的 Typed Transaction 實現的。
- **關聯**: [[eip-2929]] (Related to Access Lists)
